<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç¾½çƒæ’å ´å°å¹«æ‰‹ï¼ˆ16äºº / 2å ´åœ°ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- æ‰‹æ©ŸåŠ å…¥ä¸»ç•«é¢ç›¸é—œï¼ˆä¹‹å¾Œå¯ä»¥æ­é… icon åœ–æª”ï¼‰ -->
  <meta name="theme-color" content="#1c7ed6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ç¾½çƒæ’å ´" />
  <!-- ä¹‹å¾Œå¯ä¸Šå‚³ icon-192.png åˆ°åŒä¸€å€‹è³‡æ–™å¤¾ -->
  <link rel="icon" href="icon-192.png" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: radial-gradient(circle at top left, #e7f5ff, #f8f9fa);
    }
    h1 {
      font-size: 20px;
      text-align: center;
      margin-bottom: 8px;
      color: #1c7ed6;
    }
    .subtitle {
      text-align: center;
      font-size: 11px;
      color: #868e96;
      margin-bottom: 10px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 8px;
    }
    button {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #1c7ed6;
      color: #fff;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    button.secondary {
      background: #495057;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(0,0,0,0.12);
      opacity: 0.9;
    }
    .layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 1100px;
      margin: 0 auto;
    }
    @media (min-width: 900px) {
      .layout {
        flex-direction: row;
        align-items: flex-start;
      }
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .card h2 {
      font-size: 15px;
      margin: 0 0 8px;
      color: #343a40;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }
    th {
      background: #f1f3f5;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .player-name {
      text-align: left;
    }
    .match-area {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .court-card {
      border-radius: 14px;
      padding: 10px;
      background: linear-gradient(135deg, #e7f5ff, #f1f3f5);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.03);
    }
    .court-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 14px;
      color: #1971c2;
    }
    .teams {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-top: 4px;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }
    .pill {
      display: inline-block;
      padding: 4px 7px;
      border-radius: 999px;
      background: #fff;
      font-size: 12px;
      margin-right: 4px;
      border: 1px solid rgba(0,0,0,0.04);
      min-width: 40px;
      text-align: center;
    }
    .manual-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 4px;
      margin-top: 4px;
      margin-bottom: 6px;
      font-size: 12px;
    }
    select {
      width: 100%;
      padding: 3px 4px;
      border-radius: 6px;
      border: 1px solid #ced4da;
      font-size: 12px;
      background: #f8f9fa;
    }
    .round-label {
      font-size: 14px;
      margin-bottom: 4px;
      color: #495057;
    }
    .note {
      font-size: 11px;
      color: #868e96;
    }
    .name-input {
      width: 95%;
      padding: 2px 4px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
      box-sizing: border-box;
    }
    .stats {
      text-align: center;
      font-size: 11px;
      color: #495057;
      margin-bottom: 8px;
    }
    .badge-chip {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #f1f3f5;
      font-size: 11px;
      color: #495057;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <h1>ç¾½çƒæ’å ´å°å¹«æ‰‹ï¼ˆ16äºº / 2å ´åœ°ï¼‰</h1>
  <div class="subtitle">æ”¯æ´è‡ªå‹•æ’å ´ã€æ‰‹å‹•å¾®èª¿ã€è¨˜éŒ„ä¸Šå ´æ¬¡æ•¸ï¼Œè³‡æ–™æœƒè‡ªå‹•å­˜åœ¨é€™å°è£ç½®</div>

  <div class="controls">
    <button id="autoBtn">âš™ è‡ªå‹•æ’ä¸‹ä¸€è¼ª</button>
    <button id="manualBtn" class="secondary">âœ‹ å¥—ç”¨æ‰‹å‹•æ’å ´</button>
    <button id="resetBtn" class="secondary">ğŸ§¹ é‡ç½®ç©å®¶èˆ‡çµ±è¨ˆ</button>
  </div>

  <div id="statsBar" class="stats"></div>

  <div class="layout">
    <!-- å·¦å´ï¼šç©å®¶ç‹€æ…‹ -->
    <div class="card" style="flex: 1 1 0;">
      <h2>ç©å®¶åˆ—è¡¨ï¼ˆ1ï½16è™Ÿï¼‰</h2>
      <div class="note">
        åå­—æ¬„è¼¸å…¥ä»Šå¤©ä¾†æ‰“çš„åå­—ï¼›å‹¾ã€Œå•Ÿç”¨ã€ä»£è¡¨æœ‰ä¾†ï¼›å‹¾ã€Œä¼‘æ¯ã€ä»£è¡¨é€™ä¸€è¼ªä¸æ’é€²å ´ã€‚
      </div>
      <div style="max-height: 360px; overflow-y: auto; margin-top: 6px;">
        <table>
          <thead>
            <tr>
              <th>è™Ÿç¢¼</th>
              <th class="player-name">åå­—ï¼ˆå¯ä¿®æ”¹ï¼‰</th>
              <th>å•Ÿç”¨</th>
              <th>ä¼‘æ¯</th>
              <th>ä¸Šå ´æ¬¡æ•¸</th>
            </tr>
          </thead>
          <tbody id="playerBody">
            <!-- å‹•æ…‹ç”¢ç”Ÿ -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- å³å´ï¼šæ’å ´å€åŸŸ -->
    <div class="card" style="flex: 1.2 1 0;">
      <h2>æœ¬è¼ªæ’å ´</h2>
      <div class="round-label" id="roundLabel">ç¬¬ 1 è¼ª</div>
      <div class="match-area" id="matchArea">
        <!-- è‡ªå‹•æ’å ´çµæœ -->
      </div>

      <hr style="margin: 12px 0;" />

      <h2>æ‰‹å‹•æ’å ´ï¼ˆå¯æ”¹äººï¼‰</h2>
      <div class="note">å…ˆç”¨ä¸Šé¢çš„è‡ªå‹•æ’ï¼Œå†åœ¨é€™è£¡æ›äººï¼Œæœ€å¾ŒæŒ‰ã€Œå¥—ç”¨æ‰‹å‹•æ’å ´ã€ã€‚é‡è¤‡é¸åˆ°åŒä¸€å€‹äººç³»çµ±æœƒè­¦å‘Šã€‚</div>

      <div id="manualContainer">
        <div style="margin-top: 6px; font-weight: bold;">1 è™Ÿå ´</div>
        <div class="manual-grid" data-court="1">
          <select class="manual-select" data-slot="1"></select>
          <select class="manual-select" data-slot="2"></select>
          <select class="manual-select" data-slot="3"></select>
          <select class="manual-select" data-slot="4"></select>
        </div>

        <div style="margin-top: 6px; font-weight: bold;">2 è™Ÿå ´</div>
        <div class="manual-grid" data-court="2">
          <select class="manual-select" data-slot="5"></select>
          <select class="manual-select" data-slot="6"></select>
          <select class="manual-select" data-slot="7"></select>
          <select class="manual-select" data-slot="8"></select>
        </div>
      </div>
    </div>
  </div>

  <script>
    const NUM_PLAYERS = 16;
    const STORAGE_KEY = "badminton_state_v2";

    let players = [];
    let round = 1;
    // pairCounts: è¨˜éŒ„å…©å€‹äººç•¶éšŠå‹éå¹¾æ¬¡ï¼Œç”¨ä¾†é¿å…è€æ˜¯åŒä¸€çµ„
    let pairCounts = {};

    // ---- localStorage å„²å­˜ / è¼‰å…¥ ----
    function saveState() {
      const state = { players, round, pairCounts };
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn("ç„¡æ³•å„²å­˜åˆ° localStorageï¼š", e);
      }
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const state = JSON.parse(raw);
        const storedPlayers = Array.isArray(state.players) ? state.players : [];

        players = [];
        for (let i = 1; i <= NUM_PLAYERS; i++) {
          const sp = storedPlayers.find(p => p.id === i) || {};
          players.push({
            id: i,
            name: sp.name || (i + "è™Ÿ"),
            active: sp.active !== undefined ? !!sp.active : true,
            rest: !!sp.rest,
            games: typeof sp.games === "number" && isFinite(sp.games) ? sp.games : 0
          });
        }

        if (typeof state.round === "number" && isFinite(state.round)) {
          round = state.round;
        } else {
          round = 1;
        }

        pairCounts = state.pairCounts && typeof state.pairCounts === "object"
          ? state.pairCounts
          : {};

        return true;
      } catch (e) {
        console.warn("è®€å– localStorage å¤±æ•—ï¼Œæ”¹ç”¨é è¨­ï¼š", e);
        return false;
      }
    }

    // ---- åˆå§‹åŒ–æ–°çš„ Session ----
    function setupNewSession() {
      players = [];
      for (let i = 1; i <= NUM_PLAYERS; i++) {
        players.push({
          id: i,
          name: i + "è™Ÿ",
          active: true,
          rest: false,
          games: 0
        });
      }
      round = 1;
      pairCounts = {};
      saveState();
      renderAll();
    }

    function renderAll() {
      renderPlayers();
      renderRoundLabel();
      clearMatches();
      initManualOptions();
      updateStats();
    }

    // ---- å°å·¥å…·ï¼špair è¨ˆæ•¸ ----
    function pairKey(a, b) {
      const id1 = a.id < b.id ? a.id : b.id;
      const id2 = a.id < b.id ? b.id : a.id;
      return id1 + "-" + id2;
    }

    function getPairCount(a, b) {
      const key = pairKey(a, b);
      return pairCounts[key] || 0;
    }

    function addPairCount(a, b) {
      const key = pairKey(a, b);
      pairCounts[key] = (pairCounts[key] || 0) + 1;
    }

    function registerCourtsPairs(courts) {
      courts.forEach(court => {
        if (court.length === 4) {
          addPairCount(court[0], court[1]);
          addPairCount(court[2], court[3]);
        }
      });
    }

    // ---- UI Render ----
    function renderPlayers() {
      const tbody = document.getElementById("playerBody");
      tbody.innerHTML = "";
      players.forEach(p => {
        const tr = document.createElement("tr");

        const tdId = document.createElement("td");
        tdId.textContent = p.id;
        tr.appendChild(tdId);

        const tdName = document.createElement("td");
        tdName.className = "player-name";
        const input = document.createElement("input");
        input.type = "text";
        input.className = "name-input";
        input.value = p.name;
        input.placeholder = p.id + "è™Ÿ";
        input.addEventListener("input", () => {
          const v = input.value.trim();
          p.name = v || (p.id + "è™Ÿ");
          initManualOptions();
          saveState();
        });
        tdName.appendChild(input);
        tr.appendChild(tdName);

        const tdActive = document.createElement("td");
        const activeCheckbox = document.createElement("input");
        activeCheckbox.type = "checkbox";
        activeCheckbox.checked = p.active;
        activeCheckbox.addEventListener("change", () => {
          p.active = activeCheckbox.checked;
          if (!p.active) {
            p.rest = false;
          }
          renderPlayers();
          initManualOptions();
          updateStats();
          saveState();
        });
        tdActive.appendChild(activeCheckbox);
        tr.appendChild(tdActive);

        const tdRest = document.createElement("td");
        const restCheckbox = document.createElement("input");
        restCheckbox.type = "checkbox";
        restCheckbox.checked = p.rest;
        restCheckbox.disabled = !p.active;
        restCheckbox.addEventListener("change", () => {
          p.rest = restCheckbox.checked;
          updateStats();
          saveState();
        });
        tdRest.appendChild(restCheckbox);
        tr.appendChild(tdRest);

        const tdGames = document.createElement("td");
        tdGames.textContent = p.games;
        tr.appendChild(tdGames);

        tbody.appendChild(tr);
      });
    }

    function renderRoundLabel() {
      document.getElementById("roundLabel").textContent = "ç¬¬ " + round + " è¼ª";
    }

    function clearMatches() {
      document.getElementById("matchArea").innerHTML =
        "<div class='note'>å°šæœªæ’å ´ï¼Œè«‹æŒ‰ã€Œè‡ªå‹•æ’ä¸‹ä¸€è¼ªã€æˆ–ä½¿ç”¨ä¸‹æ–¹æ‰‹å‹•æ’å ´ã€‚</div>";
    }

    function renderMatches(courts) {
      const area = document.getElementById("matchArea");
      area.innerHTML = "";
      courts.forEach((courtPlayers, idx) => {
        const card = document.createElement("div");
        card.className = "court-card";

        const title = document.createElement("div");
        title.className = "court-title";
        title.textContent = (idx + 1) + " è™Ÿå ´";
        card.appendChild(title);

        if (courtPlayers.length < 4) {
          const info = document.createElement("div");
          info.className = "note";
          info.textContent = "äººæ•¸ä¸è¶³ 4 äººï¼Œç„¡æ³•å®Œæ•´æ’çµ„ã€‚";
          card.appendChild(info);
        } else {
          const [p1, p2, p3, p4] = courtPlayers;
          const t1 = document.createElement("div");
          t1.className = "teams";
          t1.innerHTML = `
            <span>
              <span class="pill">${p1.name}</span>
              <span class="pill">${p2.name}</span>
            </span>
            <span>VS</span>
            <span>
              <span class="pill">${p3.name}</span>
              <span class="pill">${p4.name}</span>
            </span>
          `;
          card.appendChild(t1);

          const info = document.createElement("div");
          info.className = "note";
          info.textContent = "ç³»çµ±æœƒç›¡é‡é¿å…åŒä¸€çµ„éšŠå‹ä¸€ç›´é‡è¤‡ã€‚";
          card.appendChild(info);
        }
        area.appendChild(card);
      });
    }

    function updateStats() {
      const total = players.length;
      const active = players.filter(p => p.active).length;
      const resting = players.filter(p => p.active && p.rest).length;
      const canPlay = players.filter(p => p.active && !p.rest).length;
      const statsBar = document.getElementById("statsBar");
      statsBar.innerHTML =
        `ç¸½äººæ•¸ ${total}ï¼Œå•Ÿç”¨ ${active}ï¼Œç›®å‰å¯ä¸Šå ´ ${canPlay}ï¼Œæœ¬è¼ªä¼‘æ¯ ${resting}` +
        `<span class="badge-chip">ç¬¬ ${round} è¼ª</span>`;
    }

    // ---- æ’å ´é‚è¼¯ ----

    // çµ¦ 4 å€‹äººï¼Œæ‰¾å‡ºã€Œå…©å…©é…å°ã€æ™‚éšŠå‹é‡è¤‡æ¬¡æ•¸æœ€å°‘çš„çµ„åˆ
    function makeCourtWithBestPairs(group) {
      if (group.length < 4) return group.slice();

      const [a, b, c, d] = group;
      const options = [
        [[a, b], [c, d]],
        [[a, c], [b, d]],
        [[a, d], [b, c]]
      ];

      function score(opt) {
        const [[x1, x2], [y1, y2]] = opt;
        return getPairCount(x1, x2) + getPairCount(y1, y2);
      }

      let best = options[0];
      let bestScore = score(best);
      for (let i = 1; i < options.length; i++) {
        const sc = score(options[i]);
        if (sc < bestScore) {
          bestScore = sc;
          best = options[i];
        }
      }
      return [best[0][0], best[0][1], best[1][0], best[1][1]];
    }

    function buildCourtsFromSelected(selected) {
      const courts = [];
      if (selected.length >= 4) {
        const g1 = selected.slice(0, 4);
        courts.push(makeCourtWithBestPairs(g1));
      }
      if (selected.length >= 8) {
        const g2 = selected.slice(4, 8);
        courts.push(makeCourtWithBestPairs(g2));
      }
      return courts;
    }

    function autoSchedule() {
      const available = players.filter(p => p.active && !p.rest);
      if (available.length < 4) {
        alert("å¯ä¸Šå ´äººæ•¸ä¸è¶³ 4 äººï¼Œç„¡æ³•æ’å ´ã€‚è«‹æª¢æŸ¥å•Ÿç”¨èˆ‡ä¼‘æ¯ç‹€æ…‹ã€‚");
        return;
      }

      // ä¾ä¸Šå ´æ¬¡æ•¸å°‘çš„å„ªå…ˆã€å†ä¾ç·¨è™Ÿ
      available.sort((a, b) => {
        if (a.games !== b.games) return a.games - b.games;
        return a.id - b.id;
      });

      const needed = Math.min(available.length, 8); // æœ€å¤šå…©å ´
      const selected = available.slice(0, needed);

      const courts = buildCourtsFromSelected(selected);

      // æ›´æ–°ä¸Šå ´æ¬¡æ•¸ & éšŠå‹é…å°æ¬¡æ•¸
      courts.flat().forEach(p => {
        if (p) p.games++;
      });
      registerCourtsPairs(courts);

      renderMatches(courts);
      renderPlayers();
      round++;
      renderRoundLabel();
      fillManualFromCurrent(courts);
      updateStats();
      saveState();
    }

    function initManualOptions() {
      const selects = document.querySelectorAll(".manual-select");
      selects.forEach(sel => {
        const current = sel.value;
        sel.innerHTML = "";
        const emptyOpt = document.createElement("option");
        emptyOpt.value = "";
        emptyOpt.textContent = "ç©º";
        sel.appendChild(emptyOpt);

        players.forEach(p => {
          if (!p.active) return;
          const opt = document.createElement("option");
          opt.value = String(p.id);
          opt.textContent = p.name;
          sel.appendChild(opt);
        });

        if (current) sel.value = current;
      });
    }

    function fillManualFromCurrent(courts) {
      const selects = document.querySelectorAll(".manual-select");
      selects.forEach(sel => (sel.value = ""));
      const flat = courts.flat();
      flat.forEach((p, index) => {
        if (index < selects.length) {
          selects[index].value = String(p.id);
        }
      });
    }

    function applyManualSchedule() {
      const selects = Array.from(document.querySelectorAll(".manual-select"));
      const chosenIds = selects
        .map(sel => sel.value)
        .filter(v => v !== "");

      const set = new Set(chosenIds);
      if (set.size !== chosenIds.length) {
        alert("åŒä¸€å€‹äººè¢«é¸åˆ°å…©æ¬¡ä»¥ä¸Šï¼Œè«‹æª¢æŸ¥æ‰‹å‹•æ’å ´ã€‚");
        return;
      }

      if (chosenIds.length < 4) {
        alert("è‡³å°‘è¦é¸ 4 å€‹äººæ‰èƒ½æ’ä¸€å ´ã€‚");
        return;
      }

      const idToPlayer = id => players.find(p => String(p.id) === String(id));
      const courts = [];

      const court1 = chosenIds.slice(0, 4).map(idToPlayer).filter(Boolean);
      if (court1.length === 4) courts.push(makeCourtWithBestPairs(court1));

      const court2Ids = chosenIds.slice(4, 8);
      if (court2Ids.length === 4) {
        const court2 = court2Ids.map(idToPlayer).filter(Boolean);
        if (court2.length === 4) courts.push(makeCourtWithBestPairs(court2));
      }

      if (courts.length === 0) {
        alert("æ‰‹å‹•æ’å ´äººæ•¸ä¸è¶³ã€‚");
        return;
      }

      courts.flat().forEach(p => {
        if (p) p.games++;
      });
      registerCourtsPairs(courts);

      renderMatches(courts);
      renderPlayers();
      round++;
      renderRoundLabel();
      updateStats();
      saveState();
    }

    // ---- äº‹ä»¶ç¶å®š & å•Ÿå‹• ----
    document.getElementById("autoBtn").addEventListener("click", autoSchedule);
    document.getElementById("manualBtn").addEventListener("click", applyManualSchedule);
    document.getElementById("resetBtn").addEventListener("click", () => {
      try {
        localStorage.removeItem(STORAGE_KEY);
      } catch (e) {
        console.warn("æ¸…é™¤ localStorage å¤±æ•—ï¼š", e);
      }
      setupNewSession();
    });

    (function start() {
      const loaded = loadState();
      if (!loaded) {
        setupNewSession();
      } else {
        renderAll();
      }
    })();
  </script>
</body>
</html>
