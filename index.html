<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ç¾½æäººæ­¡æ¨‚åœ˜ï¼ˆ16äºº / 2å ´åœ°ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- æ‰‹æ©ŸåŠ å…¥ä¸»ç•«é¢è¨­å®š -->
  <meta name="theme-color" content="#1c7ed6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="ç¾½çƒæ’å ´" />

  <!-- ç¶²ç«™ faviconï¼ˆä¸€èˆ¬ç€è¦½å™¨ç”¨ï¼‰ -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <!-- Android / PWA é«˜è§£æ icon -->
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <!-- iPhone / iPad ä¸»ç•«é¢å°ˆç”¨ icon -->
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 16px;
      background: radial-gradient(circle at top left, #e7f5ff, #f8f9fa);
    }
    h1 {
      font-size: 20px;
      text-align: center;
      margin-bottom: 8px;
      color: #1c7ed6;
    }
    .subtitle {
      text-align: center;
      font-size: 11px;
      color: #868e96;
      margin-bottom: 10px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 8px;
    }
    .section-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: flex-start;
      margin: 4px 0 8px;
    }
    button {
      padding: 8px 12px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #1c7ed6;
      color: #fff;
      font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    button.secondary {
      background: #495057;
    }
    button:active {
      transform: translateY(1px);
      box-shadow: 0 1px 4px rgba(0,0,0,0.12);
      opacity: 0.9;
    }
    .layout {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 1100px;
      margin: 0 auto;
    }
    @media (min-width: 900px) {
      .layout {
        flex-direction: row;
        align-items: flex-start;
      }
    }
    .card {
      background: #fff;
      border-radius: 16px;
      padding: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    .card h2 {
      font-size: 15px;
      margin: 0 0 8px;
      color: #343a40;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      padding: 4px 6px;
      border-bottom: 1px solid #eee;
      text-align: center;
    }
    th {
      background: #f1f3f5;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .player-name {
      text-align: left;
    }
    .match-area {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .court-card {
      border-radius: 14px;
      padding: 10px;
      background: linear-gradient(135deg, #e7f5ff, #f1f3f5);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.03);
    }
    .court-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 14px;
      color: #1971c2;
    }
    .teams {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      margin-top: 4px;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }
    .pill {
      display: inline-block;
      padding: 4px 7px;
      border-radius: 999px;
      background: #fff;
      font-size: 12px;
      margin-right: 4px;
      border: 1px solid rgba(0,0,0,0.04);
      min-width: 40px;
      text-align: center;
    }
    .manual-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 4px;
      margin-top: 4px;
      margin-bottom: 6px;
      font-size: 12px;
    }
    select {
      width: 100%;
      padding: 3px 4px;
      border-radius: 6px;
      border: 1px solid #ced4da;
      font-size: 12px;
      background: #f8f9fa;
    }
    .round-label {
      font-size: 14px;
      margin-bottom: 4px;
      color: #495057;
    }
    .note {
      font-size: 11px;
      color: #868e96;
    }
    .name-input {
      width: 95%;
      padding: 2px 4px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #dee2e6;
      box-sizing: border-box;
    }
    .stats {
      text-align: center;
      font-size: 11px;
      color: #495057;
      margin-bottom: 8px;
    }
    .badge-chip {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #f1f3f5;
      font-size: 11px;
      color: #495057;
      margin-left: 4px;
    }

    /* å ´åœ°å¤§åœ–ï¼ˆæœ¬å ´ + ä¸‹ä¸€å ´ï¼‰ */
    .board {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 10px;
    }
    @media (min-width: 900px) {
      .board {
        flex-direction: row;
      }
    }
    .court-board {
      flex: 1;
      background: #0b7285;
      color: #fff;
      border-radius: 16px;
      padding: 10px 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }
    .court-board-title {
      font-weight: 600;
      text-align: center;
      margin-bottom: 4px;
      font-size: 14px;
    }
    .court-label {
      font-size: 12px;
      margin: 4px 0;
      text-align: left;
      opacity: 0.9;
    }
    .court-layout {
      position: relative;
      background: #18663d;
      border-radius: 12px;
      border: 2px solid #f8f9fa;
      height: 140px;
      margin-bottom: 4px;
      overflow: hidden;
    }
    .court-line-outer {
      position: absolute;
      inset: 6px;
      border: 2px solid rgba(248, 249, 250, 0.7);
      border-radius: 8px;
    }
    .court-line-middle {
      position: absolute;
      top: 50%;
      left: 6px;
      right: 6px;
      height: 2px;
      background: rgba(248, 249, 250, 0.9);
    }
    .court-line-center {
      position: absolute;
      left: 50%;
      top: 6px;
      bottom: 6px;
      width: 2px;
      background: rgba(248, 249, 250, 0.6);
    }
    .court-net {
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 4px;
      margin-top: -2px;
      background: linear-gradient(to right, rgba(255,255,255,0.9), rgba(255,255,255,0.6));
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
    }
    .player-slot {
      position: absolute;
      width: 48%;
      text-align: center;
      font-size: 12px;
      color: #343a40;
      padding: 2px 3px;
      border-radius: 999px;
      background: rgba(255, 243, 205, 0.95); /* é¡¯çœ¼é»ƒè‰² */
      border: 1px solid rgba(0,0,0,0.15);
      box-shadow: 0 0 4px rgba(0,0,0,0.25);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .slot-1 { top: 10px; left: 2%; }
    .slot-2 { top: 10px; right: 2%; }
    .slot-3 { bottom: 10px; left: 2%; }
    .slot-4 { bottom: 10px; right: 2%; }

    .court-layout.next {
      background: #115f72;
    }
    .court-empty-text {
      font-size: 12px;
      text-align: center;
      margin: 6px 0 2px;
      opacity: 0.8;
    }

    /* ä¸‹ä¸€å ´é ç´„ç¸½è¦½ï¼šç”¨é†’ç›®çš„èƒŒæ™¯é¡è‰² */
    .next-summary {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      background: #fff5f5;
      border-left: 4px solid #f03e3e;
      font-size: 12px;
      color: #343a40;
    }
    .next-summary-title {
      font-weight: 700;
      margin-bottom: 4px;
      font-size: 13px;
      color: #d9480f;
    }
    .next-summary-court {
      margin-bottom: 4px;
    }
    .next-summary-court-name {
      font-weight: 600;
      margin-right: 4px;
      color: #212529;
    }
    .next-summary-empty {
      font-size: 11px;
      color: #868e96;
    }
    .next-summary .pill {
      background: #ffe8cc;
      border: 1px solid #ffa94d;
      color: #9c36b5;
      margin-right: 4px;
    }
  </style>
</head>
<body>
  <h1>ç¾½æäººæ’å ´å°åŠ©ç†ï¼ˆ16äºº / 2å ´åœ°ï¼‰</h1>
  <div class="subtitle">å…¨éƒ¨æ‰‹å‹•æ’å ´ï¼Œæœ¬å ´èˆ‡ä¸‹ä¸€å ´é ç´„åˆ†é–‹ç®¡ç†ï¼Œå¯åªæ›´æ–°å…¶ä¸­ä¸€å€‹å ´åœ°</div>

  <!-- é ‚éƒ¨åªç•™é‡ç½® -->
  <div class="controls">
    <button id="resetBtn" class="secondary">ğŸ§¹ é‡ç½®ç©å®¶èˆ‡çµ±è¨ˆ</button>
  </div>

  <div id="statsBar" class="stats"></div>

  <div class="layout">
    <!-- å·¦å´ï¼šç©å®¶ç‹€æ…‹ -->
    <div class="card" style="flex: 1 1 0;">
      <h2>ç©å®¶åˆ—è¡¨ï¼ˆ1ï½16è™Ÿï¼‰</h2>
      <div class="note">
        åå­—æ¬„è¼¸å…¥ä»Šå¤©ä¾†æ‰“çš„åå­—ï¼›å‹¾ã€Œå•Ÿç”¨ã€ä»£è¡¨æœ‰ä¾†ï¼›å‹¾ã€Œä¼‘æ¯ã€åªæ˜¯æ¨™è¨˜ç”¨ï¼Œä¸å½±éŸ¿ä½ æ‰‹å‹•æ’å ´ã€‚
      </div>
      <div style="max-height: 360px; overflow-y: auto; margin-top: 6px;">
        <table>
          <thead>
            <tr>
              <th>è™Ÿç¢¼</th>
              <th class="player-name">åå­—ï¼ˆå¯ä¿®æ”¹ï¼‰</th>
              <th>å•Ÿç”¨</th>
              <th>ä¼‘æ¯</th>
              <th>ä¸Šå ´æ¬¡æ•¸</th>
            </tr>
          </thead>
          <tbody id="playerBody"></tbody>
        </table>
      </div>
    </div>

    <!-- å³å´ï¼šæ’å ´å€åŸŸ -->
    <div class="card" style="flex: 1.2 1 0;">
      <h2>æœ¬è¼ªæ’å ´</h2>
      <div class="round-label" id="roundLabel">ç¬¬ 1 è¼ª</div>
      <div class="match-area" id="matchArea"></div>

      <div class="note" style="margin-top: 8px;">
        ä¸‹æ–¹ã€Œçƒå ´åœ–ã€å¯æŠ•å½±åœ¨è¢å¹•ä¸Šï¼šé¡¯ç¤ºæ¯å€‹å ´åœ°æœ¬å ´ï¼†ä¸‹ä¸€å ´çš„ä¸Šå ´äººå“¡ã€‚
      </div>
      <div id="boardView" class="board"></div>

      <!-- ä¸‹ä¸€å ´é ç´„ç¸½è¦½ï¼ˆé¡¯ç¤ºåœ¨çƒå ´åœ–ä¸‹æ–¹ï¼‰ -->
      <div id="nextSummary" class="next-summary"></div>

      <hr style="margin: 12px 0;" />

      <h2>æ‰‹å‹•æ’å ´ï¼ˆæœ¬å ´ï¼‰</h2>
      <div class="note">
        é€™è£¡çš„ä¸‹æ‹‰æ˜¯ã€Œæ’ä¸‹ä¸€è¼ªè¦ä¸Šå ´çš„äººã€ã€‚<br/>
        æ¯å€‹å ´åœ°å¯ä»¥ã€Œ0 äººã€ï¼ˆä¸è®Šï¼‰æˆ–ã€Œ4 äººã€ï¼ˆåªæ›´æ–°è©²å ´åœ°ï¼‰ã€‚<br/>
        âš  è‹¥ 1 è™Ÿå ´èˆ‡ 2 è™Ÿå ´æœ¬å ´éƒ½å·²ç¶“æ’å¥½ 4 äººï¼ŒåˆåŒæ™‚æ’äº† 8 å€‹äººæŒ‰ä¸‹ã€Œå¥—ç”¨æœ¬å ´æ’å ´ã€ï¼Œç³»çµ±æœƒè·³å‡ºé˜²å‘†æç¤ºã€‚
      </div>

      <div id="manualContainer">
        <div style="margin-top: 6px; font-weight: bold;">1 è™Ÿå ´</div>
        <div class="manual-grid">
          <select class="manual-select" data-slot="1"></select>
          <select class="manual-select" data-slot="2"></select>
          <select class="manual-select" data-slot="3"></select>
          <select class="manual-select" data-slot="4"></select>
        </div>

        <div style="margin-top: 6px; font-weight: bold;">2 è™Ÿå ´</div>
        <div class="manual-grid">
          <select class="manual-select" data-slot="5"></select>
          <select class="manual-select" data-slot="6"></select>
          <select class="manual-select" data-slot="7"></select>
          <select class="manual-select" data-slot="8"></select>
        </div>
      </div>

      <!-- æ‰‹å‹•æ’å ´å°ˆç”¨æŒ‰éˆ• -->
      <div class="section-controls">
        <button id="manualBtn" class="secondary">âœ‹ å¥—ç”¨æœ¬å ´æ’å ´</button>
      </div>

      <hr style="margin: 12px 0;" />

      <h2>ä¸‹ä¸€å ´é ç´„æ’å ´</h2>
      <div class="note">
        æƒ³å…ˆé ç´„ä¸‹ä¸€è¼ªçš„åå–®ï¼Œå¯ä»¥åœ¨é€™è£¡æ’ã€‚<br/>
        æ¯å€‹å ´åœ°å¯ä»¥ã€Œ0 äººã€æˆ–ã€Œ4 äººã€ï¼›å¯ä»¥åªé ç´„ 1 è™Ÿå ´ï¼Œ2 è™Ÿå ´å…¨éƒ¨ç•™ç©ºã€‚<br/>
        æŒ‰ã€Œ1 è™Ÿå ´ / 2 è™Ÿå ´ä¸‹ä¸€å ´ä¸Šå ´ã€æ™‚ï¼Œåªæœƒæ›´æ–°é‚£ä¸€å€‹å ´åœ°ã€‚
      </div>

      <div id="manualNextContainer">
        <div style="margin-top: 6px; font-weight: bold;">é ç´„ 1 è™Ÿå ´</div>
        <div class="manual-grid">
          <select class="manual-next-select" data-slot="n1"></select>
          <select class="manual-next-select" data-slot="n2"></select>
          <select class="manual-next-select" data-slot="n3"></select>
          <select class="manual-next-select" data-slot="n4"></select>
        </div>

        <div style="margin-top: 6px; font-weight: bold;">é ç´„ 2 è™Ÿå ´ï¼ˆå¯ç•™ç™½ï¼‰</div>
        <div class="manual-grid">
          <select class="manual-next-select" data-slot="n5"></select>
          <select class="manual-next-select" data-slot="n6"></select>
          <select class="manual-next-select" data-slot="n7"></select>
          <select class="manual-next-select" data-slot="n8"></select>
        </div>
      </div>

      <!-- ä¸‹ä¸€å ´é ç´„å°ˆç”¨æŒ‰éˆ• -->
      <div class="section-controls">
        <button id="nextCourt1Btn" class="secondary">â–¶ 1 è™Ÿå ´ä¸‹ä¸€å ´ä¸Šå ´</button>
        <button id="nextCourt2Btn" class="secondary">â–¶ 2 è™Ÿå ´ä¸‹ä¸€å ´ä¸Šå ´</button>
        <button id="saveNextBtn" class="secondary">ğŸ’¾ å„²å­˜ä¸‹ä¸€å ´é ç´„</button>
      </div>
    </div>
  </div>

  <script>
    const NUM_PLAYERS = 16;
    const STORAGE_KEY = "badminton_state_v15";

    let players = [];
    let round = 0;          // 0 è¡¨ç¤ºå°šæœªé–‹å§‹
    let pairCounts = {};
    let currentCourts = []; // [[player,player,player,player], ...]
    let queuedCourts = [];  // [ [id,id,id,id] | [], [id,id,id,id] | [] ]

    // ---------- localStorage ----------
    function saveState() {
      const state = {
        players,
        round,
        pairCounts,
        queuedCourts,
        currentCourtsIds: currentCourts.map(c => c.map(p => p.id))
      };
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch (e) {}
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return false;
        const state = JSON.parse(raw);
        const storedPlayers = Array.isArray(state.players) ? state.players : [];

        players = [];
        for (let i = 1; i <= NUM_PLAYERS; i++) {
          const sp = storedPlayers.find(p => p.id === i) || {};
          players.push({
            id: i,
            name: sp.name || (i + "è™Ÿ"),
            active: sp.active !== undefined ? !!sp.active : true,
            rest: !!sp.rest,
            games: typeof sp.games === "number" && isFinite(sp.games) ? sp.games : 0
          });
        }

        round = (typeof state.round === "number" && isFinite(state.round)) ? state.round : 0;
        pairCounts = state.pairCounts && typeof state.pairCounts === "object" ? state.pairCounts : {};
        queuedCourts = Array.isArray(state.queuedCourts) ? state.queuedCourts : [];

        const idsCourts = Array.isArray(state.currentCourtsIds) ? state.currentCourtsIds : [];
        currentCourts = idsCourts.map(courtIds =>
          courtIds
            .map(id => players.find(p => p.id === id))
            .filter(Boolean)
        );

        return true;
      } catch (e) {
        return false;
      }
    }

    function setupNewSession() {
      players = [];
      for (let i = 1; i <= NUM_PLAYERS; i++) {
        players.push({
          id: i,
          name: i + "è™Ÿ",
          active: true,
          rest: false,
          games: 0
        });
      }
      round = 0;
      pairCounts = {};
      currentCourts = [];
      queuedCourts = [];
      saveState();
      renderAll();
    }

    function renderAll() {
      renderPlayers();
      renderRoundLabel();
      initManualOptions();
      clearManualSelects();
      updateStats();
      renderMatches(currentCourts, getQueuedCourtsAsPlayers());
      renderNextSummary();
      resetManualNextFromQueue();
    }

    // ---------- æ­æª”çµ±è¨ˆ ----------
    function pairKey(a, b) {
      const id1 = a.id < b.id ? a.id : b.id;
      const id2 = a.id < b.id ? b.id : a.id;
      return id1 + "-" + id2;
    }
    function addPairCount(a, b) {
      const k = pairKey(a, b);
      pairCounts[k] = (pairCounts[k] || 0) + 1;
    }
    function registerCourtsPairs(courts) {
      courts.forEach(c => {
        if (c.length === 4) {
          addPairCount(c[0], c[1]);
          addPairCount(c[2], c[3]);
        }
      });
    }

    // ---------- UI ----------
    function renderPlayers() {
      const tbody = document.getElementById("playerBody");
      tbody.innerHTML = "";
      players.forEach(p => {
        const tr = document.createElement("tr");

        const tdId = document.createElement("td");
        tdId.textContent = p.id;
        tr.appendChild(tdId);

        const tdName = document.createElement("td");
        tdName.className = "player-name";
        const input = document.createElement("input");
        input.type = "text";
        input.className = "name-input";
        input.value = p.name;
        input.placeholder = p.id + "è™Ÿ";
        input.addEventListener("input", () => {
          const v = input.value.trim();
          p.name = v || (p.id + "è™Ÿ");
          initManualOptions();
          resetManualNextFromQueue();
          renderNextSummary();
          saveState();
        });
        tdName.appendChild(input);
        tr.appendChild(tdName);

        const tdActive = document.createElement("td");
        const chkA = document.createElement("input");
        chkA.type = "checkbox";
        chkA.checked = p.active;
        chkA.addEventListener("change", () => {
          p.active = chkA.checked;
          if (!p.active) p.rest = false;
          renderPlayers();
          initManualOptions();
          clearManualSelects();
          updateStats();
          resetManualNextFromQueue();
          renderNextSummary();
          saveState();
        });
        tdActive.appendChild(chkA);
        tr.appendChild(tdActive);

        const tdRest = document.createElement("td");
        const chkR = document.createElement("input");
        chkR.type = "checkbox";
        chkR.checked = p.rest;
        chkR.disabled = !p.active;
        chkR.addEventListener("change", () => {
          p.rest = chkR.checked;
          updateStats();
          saveState();
        });
        tdRest.appendChild(chkR);
        tr.appendChild(tdRest);

        const tdGames = document.createElement("td");
        tdGames.textContent = p.games;
        tr.appendChild(tdGames);

        tbody.appendChild(tr);
      });
    }

    function renderRoundLabel() {
      const label = document.getElementById("roundLabel");
      if (round <= 0) {
        label.textContent = "ç¬¬ 1 è¼ª";
      } else {
        label.textContent = "ç¬¬ " + round + " è¼ª";
      }
    }

    function updateStats() {
      const total = players.length;
      const active = players.filter(p => p.active).length;
      const resting = players.filter(p => p.active && p.rest).length;
      const canPlay = players.filter(p => p.active && !p.rest).length;
      const statsBar = document.getElementById("statsBar");
      statsBar.innerHTML =
        `ç¸½äººæ•¸ ${total}ï¼Œå•Ÿç”¨ ${active}ï¼Œç›®å‰å¯ä¸Šå ´ ${canPlay}ï¼Œæ¨™è¨˜ä¼‘æ¯ ${resting}` +
        `<span class="badge-chip">ç›®å‰é¡¯ç¤ºï¼šç¬¬ ${round <= 0 ? 1 : round} è¼ª</span>`;
    }

    function renderMatches(courts, nextCourts) {
      const area = document.getElementById("matchArea");
      area.innerHTML = "";
      if (!courts || courts.length === 0) {
        area.innerHTML = "<div class='note'>å°šæœªæ’å ´ï¼Œè«‹åœ¨ä¸‹æ–¹é¸å¥½æœ¬å ´åå–®å¾ŒæŒ‰ã€Œå¥—ç”¨æœ¬å ´æ’å ´ã€ï¼Œæˆ–å…ˆä½¿ç”¨ã€Œä¸‹ä¸€å ´é ç´„ã€æ­é…å„å ´åœ°çš„ã€Œä¸‹ä¸€å ´ä¸Šå ´ã€ã€‚</div>";
      } else {
        courts.forEach((courtPlayers, idx) => {
          const card = document.createElement("div");
          card.className = "court-card";

          const title = document.createElement("div");
          title.className = "court-title";
          title.textContent = (idx + 1) + " è™Ÿå ´";
          card.appendChild(title);

          if (courtPlayers.length < 4) {
            const info = document.createElement("div");
            info.className = "note";
            info.textContent = "äººæ•¸ä¸è¶³ 4 äººã€‚";
            card.appendChild(info);
          } else {
            const [p1, p2, p3, p4] = courtPlayers;
            const t1 = document.createElement("div");
            t1.className = "teams";
            t1.innerHTML = `
              <span>
                <span class="pill">${p1.name}</span>
                <span class="pill">${p2.name}</span>
              </span>
              <span>VS</span>
              <span>
                <span class="pill">${p3.name}</span>
                <span class="pill">${p4.name}</span>
              </span>
            `;
            card.appendChild(t1);
          }
          area.appendChild(card);
        });
      }

      const board = document.getElementById("boardView");
      board.innerHTML = "";
      const maxCourts = Math.max(courts.length, nextCourts.length, 2); // é¡¯ç¤ºåˆ° 2 è™Ÿå ´
      for (let i = 0; i < maxCourts; i++) {
        const current = courts[i] || [];
        const showNextForThisCourt = (courts.length === 0) || (i < courts.length);
        const next = showNextForThisCourt ? (nextCourts[i] || []) : [];

        const b = document.createElement("div");
        b.className = "court-board";

        const title = document.createElement("div");
        title.className = "court-board-title";
        title.textContent = (i + 1) + " è™Ÿå ´";
        b.appendChild(title);

        // æœ¬å ´
        const labelNow = document.createElement("div");
        labelNow.className = "court-label";
        labelNow.textContent = "æœ¬å ´";
        b.appendChild(labelNow);

        const layoutNow = document.createElement("div");
        layoutNow.className = "court-layout";

        const outerNow = document.createElement("div");
        outerNow.className = "court-line-outer";
        const midNow = document.createElement("div");
        midNow.className = "court-line-middle";
        const centerNow = document.createElement("div");
        centerNow.className = "court-line-center";
        const netNow = document.createElement("div");
        netNow.className = "court-net";

        layoutNow.appendChild(outerNow);
        layoutNow.appendChild(midNow);
        layoutNow.appendChild(centerNow);
        layoutNow.appendChild(netNow);

        for (let s = 0; s < 4; s++) {
          const cell = document.createElement("div");
          cell.className = "player-slot slot-" + (s + 1);
          const p = current[s];
          cell.textContent = p ? p.name : "â€”";
          layoutNow.appendChild(cell);
        }
        b.appendChild(layoutNow);


        // â¬‡ é€™è£¡æ”¹æ‰ï¼šå¦‚æœæ²’æœ‰æ»¿ 4 äººï¼Œå°±ä»€éº¼éƒ½ä¸é¡¯ç¤ºï¼ˆä¸å†é¡¯ç¤ºã€Œå°šæœªæ’æ»¿ 4 äººã€ï¼‰
        if (showNextForThisCourt && next.length === 4) {
          const layoutNext = document.createElement("div");
          layoutNext.className = "court-layout next";

          const outerNext = document.createElement("div");
          outerNext.className = "court-line-outer";
          const midNext = document.createElement("div");
          midNext.className = "court-line-middle";
          const centerNext = document.createElement("div");
          centerNext.className = "court-line-center";
          const netNext = document.createElement("div");
          netNext.className = "court-net";

          layoutNext.appendChild(outerNext);
          layoutNext.appendChild(midNext);
          layoutNext.appendChild(centerNext);
          layoutNext.appendChild(netNext);

          for (let s = 0; s < 4; s++) {
            const cell = document.createElement("div");
            cell.className = "player-slot slot-" + (s + 1);
            const p = next[s];
            cell.textContent = p ? p.name : "â€”";
            layoutNext.appendChild(cell);
          }
          b.appendChild(layoutNext);
        }

        board.appendChild(b);
      }
    }

    // ---------- ä¸‹ä¸€å ´é ç´„ç¸½è¦½ ----------
    function renderNextSummary() {
      const box = document.getElementById("nextSummary");
      if (!box) return;

      let html = '<div class="next-summary-title">ä¸‹ä¸€å ´é ç´„ï¼ˆåå–®ç¸½è¦½ï¼‰</div>';
      let any = false;

      for (let i = 0; i < 2; i++) {
        const ids = (queuedCourts[i] || []).filter(Boolean);
        html += '<div class="next-summary-court">';
        html += '<span class="next-summary-court-name">' + (i + 1) + ' è™Ÿå ´ï¼š</span>';

        if (ids.length === 4) {
          any = true;
          const pills = ids.map(id => {
            const p = players.find(pl => pl.id === id);
            const name = p ? p.name : (id + "è™Ÿ");
            return '<span class="pill">' + name + '</span>';
          }).join("");
          html += pills;
        } else {
          html += '<span class="next-summary-empty">å°šæœªé ç´„</span>';
        }

        html += '</div>';
      }

      if (!any) {
        html += '<div class="next-summary-empty">ç›®å‰æ²’æœ‰ä»»ä½•å ´åœ°æ’å¥½ä¸‹ä¸€å ´ï¼Œæ’å¥½å¾ŒæŒ‰ã€Œå„²å­˜ä¸‹ä¸€å ´é ç´„ã€å³å¯åœ¨é€™è£¡çœ‹åˆ°ã€‚</div>';
      }

      box.innerHTML = html;
    }

    // ---------- é¸å–®åˆå§‹åŒ– ----------
    function initManualOptions() {
      const manualSelects = document.querySelectorAll(".manual-select");
      manualSelects.forEach(sel => {
        const current = sel.value;
        sel.innerHTML = "";
        const empty = document.createElement("option");
        empty.value = "";
        empty.textContent = "ç©º";
        sel.appendChild(empty);

        players.forEach(p => {
          if (!p.active) return;
          const opt = document.createElement("option");
          opt.value = String(p.id);
          opt.textContent = p.name;
          sel.appendChild(opt);
        });
        if (current) sel.value = current;
      });

      const nextSelects = document.querySelectorAll(".manual-next-select");
      nextSelects.forEach(sel => {
        const current = sel.value;
        sel.innerHTML = "";
        const empty = document.createElement("option");
        empty.value = "";
        empty.textContent = "ç©º";
        sel.appendChild(empty);

        players.forEach(p => {
          if (!p.active) return;
          const opt = document.createElement("option");
          opt.value = String(p.id);
          opt.textContent = p.name;
          sel.appendChild(opt);
        });
        if (current) sel.value = current;
      });
    }

    function clearManualSelects() {
      document.querySelectorAll(".manual-select").forEach(sel => sel.value = "");
    }

    function resetManualNextFromQueue() {
      const selects = Array.from(document.querySelectorAll(".manual-next-select"));
      selects.forEach(sel => (sel.value = ""));
      if (!queuedCourts || queuedCourts.length === 0) return;
      for (let i = 0; i < queuedCourts.length; i++) {
        const ids = queuedCourts[i] || [];
        for (let j = 0; j < ids.length && j < 4; j++) {
          const idx = i * 4 + j;
          if (selects[idx]) selects[idx].value = String(ids[j]);
        }
      }
    }

    // ---------- queuedCourts è½‰ç©å®¶ ----------
    function getQueuedCourtsAsPlayers() {
      if (!queuedCourts || queuedCourts.length === 0) return [];
      const result = [];
      for (let i = 0; i < 2; i++) {
        const ids = (queuedCourts[i] || []).filter(Boolean);
        if (ids.length === 4) {
          const courtPlayers = ids
            .map(id => players.find(p => p.id === id))
            .filter(Boolean);
          result[i] = courtPlayers;
        } else {
          result[i] = [];
        }
      }
      return result;
    }

    // ---------- å¥—ç”¨æœ¬å ´æ’å ´ï¼šé€å ´åœ°è™•ç†ï¼ˆå«é˜²å‘†ï¼‰ ----------
    function applyManualSchedule() {
      const selects = Array.from(document.querySelectorAll(".manual-select"));
      const idToPlayer = id => players.find(p => String(p.id) === String(id));
      const newCourts = currentCourts.slice();
      let updatedAny = false;

      // å…ˆæŠŠæ‰‹å‹•è¦æ’çš„äººè®€å‡ºä¾†ï¼ˆå…©å€‹å ´åœ°å„è‡ªçš„ 0 æˆ– 4 äººï¼‰
      const manualIds = [[], []];
      for (let courtIndex = 0; courtIndex < 2; courtIndex++) {
        const start = courtIndex * 4;
        const end = start + 4;
        const ids = selects.slice(start, end)
          .map(sel => sel.value)
          .filter(v => v !== "");
        manualIds[courtIndex] = ids;
      }

      // é˜²å‘†ï¼šå¦‚æœ 1ã€2 è™Ÿå ´æœ¬å ´éƒ½å·²ç¶“æœ‰æ’å ´ï¼Œä¸”æ‰‹å‹•åˆåŒæ™‚æ’æ»¿å…©å ´ï¼ˆ8 äººï¼‰ï¼Œç›´æ¥æ‹’çµ•
      const c1Has = Array.isArray(currentCourts[0]) && currentCourts[0].length > 0;
      const c2Has = Array.isArray(currentCourts[1]) && currentCourts[1].length > 0;
      if (c1Has && c2Has && manualIds[0].length === 4 && manualIds[1].length === 4) {
        alert(
          "ç›®å‰ 1 è™Ÿå ´èˆ‡ 2 è™Ÿå ´æœ¬å ´éƒ½å·²ç¶“æœ‰äººåœ¨æ‰“ï¼Œç„¡æ³•åŒæ™‚å¥—ç”¨æœ¬å ´æ’å ´ã€‚\n\n" +
          "è«‹å…ˆè®“å…¶ä¸­ä¸€å€‹å ´åœ°çµæŸï¼ˆæˆ–åªæ’å…¶ä¸­ä¸€å€‹å ´åœ°ï¼‰ï¼Œ\n" +
          "æˆ–æ”¹ç”¨ã€Œä¸‹ä¸€å ´é ç´„ã€ï¼‹ã€Œä¸‹ä¸€å ´ä¸Šå ´ã€çš„æ–¹å¼ã€‚"
        );
        return;
      }

      // é€å ´åœ°æª¢æŸ¥ & å¥—ç”¨
      for (let courtIndex = 0; courtIndex < 2; courtIndex++) {
        const ids = manualIds[courtIndex];

        if (ids.length === 0) {
          // é€™å€‹å ´åœ°ä¸è®Š
          continue;
        }
        if (ids.length !== 4) {
          alert((courtIndex + 1) + " è™Ÿå ´æœ¬å ´æ’å ´è«‹æ’ 0 æˆ– 4 å€‹äººã€‚");
          return;
        }
        const set = new Set(ids);
        if (set.size !== ids.length) {
          alert((courtIndex + 1) + " è™Ÿå ´æœ¬å ´æ’å ´æœ‰é‡è¤‡çš„äººã€‚");
          return;
        }

        const courtPlayers = ids.map(idToPlayer).filter(Boolean);
        if (courtPlayers.length !== 4) {
          alert((courtIndex + 1) + " è™Ÿå ´æœ¬å ´æ’å ´æœ‰ç„¡æ•ˆçš„ç©å®¶ã€‚");
          return;
        }

        newCourts[courtIndex] = courtPlayers;
        courtPlayers.forEach(p => { if (p) p.games++; });
        registerCourtsPairs([courtPlayers]);
        updatedAny = true;
      }

      if (!updatedAny) {
        alert("è«‹è‡³å°‘ç‚ºä¸€å€‹å ´åœ°æ’æ»¿ 4 äººå†å¥—ç”¨æœ¬å ´æ’å ´ã€‚");
        return;
      }

      currentCourts = newCourts;
      round++;
      renderRoundLabel();
      renderPlayers();
      updateStats();
      renderMatches(currentCourts, getQueuedCourtsAsPlayers());
      clearManualSelects();
      saveState();
    }

    // ---------- æŸä¸€å€‹å ´åœ°ï¼šä¸‹ä¸€å ´ä¸Šå ´ ----------
    function nextRoundFromQueue(courtIndex) {
      const selects = Array.from(document.querySelectorAll(".manual-next-select"));
      const idToPlayer = id => players.find(p => String(p.id) === String(id));
      const newCourts = currentCourts.slice();

      // å…ˆçœ‹ queue
      let ids = (queuedCourts[courtIndex] || []).filter(Boolean);

      // è‹¥ queue ä¸è¶³ 4 å€‹ï¼Œæ”¹ç”¨ç›®å‰é¸å–®
      if (ids.length !== 4) {
        const start = courtIndex * 4;
        const end = start + 4;
        ids = selects.slice(start, end)
          .map(sel => sel.value)
          .filter(v => v !== "");
      }

      if (ids.length === 0) {
        alert((courtIndex + 1) + " è™Ÿå ´ç›®å‰æ²’æœ‰ä»»ä½•ä¸‹ä¸€å ´é ç´„ã€‚");
        return;
      }
      if (ids.length !== 4) {
        alert((courtIndex + 1) + " è™Ÿå ´çš„ä¸‹ä¸€å ´äººæ•¸å¿…é ˆå‰›å¥½ 4 äººã€‚");
        return;
      }

      const set = new Set(ids);
      if (set.size !== ids.length) {
        alert((courtIndex + 1) + " è™Ÿå ´çš„ä¸‹ä¸€å ´åå–®æœ‰é‡è¤‡çš„äººã€‚");
        return;
      }

      const courtPlayers = ids.map(idToPlayer).filter(Boolean);
      if (courtPlayers.length !== 4) {
        alert((courtIndex + 1) + " è™Ÿå ´çš„ä¸‹ä¸€å ´åå–®æœ‰ç„¡æ•ˆçš„ç©å®¶ã€‚");
        return;
      }

      // æ›¿æ›è©²å ´åœ°
      newCourts[courtIndex] = courtPlayers;
      courtPlayers.forEach(p => { if (p) p.games++; });
      registerCourtsPairs([courtPlayers]);

      // æ¸…ç©º queue & é¸å–®
      queuedCourts[courtIndex] = [];
      const start = courtIndex * 4;
      const end = start + 4;
      selects.slice(start, end).forEach(sel => sel.value = "");

      currentCourts = newCourts;
      round++;
      renderRoundLabel();
      renderPlayers();
      updateStats();
      renderMatches(currentCourts, getQueuedCourtsAsPlayers());
      clearManualSelects();
      resetManualNextFromQueue();
      renderNextSummary();
      saveState();
    }

    // ---------- å„²å­˜ä¸‹ä¸€å ´é ç´„ ----------
    function saveNextManualSchedule() {
      const selects = Array.from(document.querySelectorAll(".manual-next-select"));
      const courtIds = [[], []];

      for (let courtIndex = 0; courtIndex < 2; courtIndex++) {
        const start = courtIndex * 4;
        const end = start + 4;
        const ids = selects.slice(start, end)
          .map(sel => sel.value)
          .filter(v => v !== "");

        if (ids.length !== 0 && ids.length !== 4) {
          alert((courtIndex + 1) + " è™Ÿå ´é ç´„è«‹æ’ 0 æˆ– 4 å€‹äººã€‚");
          return;
        }
        courtIds[courtIndex] = ids;
      }

      // æª¢æŸ¥è·¨å ´åœ°é‡è¤‡
      const allIds = [...courtIds[0], ...courtIds[1]];
      const setAll = new Set(allIds);
      if (setAll.size !== allIds.length) {
        alert("ä¸‹ä¸€å ´é ç´„ä¸­ï¼ŒåŒä¸€å€‹äººè¢«æ’åœ¨å…©å€‹å ´åœ°ã€‚");
        return;
      }

      queuedCourts = [];
      for (let i = 0; i < 2; i++) {
        if (courtIds[i].length === 4) {
          queuedCourts[i] = courtIds[i].slice();
        } else {
          queuedCourts[i] = [];
        }
      }

      saveState();
      resetManualNextFromQueue();
      renderMatches(currentCourts, getQueuedCourtsAsPlayers());
      renderNextSummary();

      if (courtIds[0].length === 0 && courtIds[1].length === 0) {
        alert("å·²æ¸…é™¤ä¸‹ä¸€å ´é ç´„æ’å ´ã€‚");
      } else {
        alert("å·²å„²å­˜ä¸‹ä¸€å ´é ç´„æ’å ´ã€‚");
      }
    }

    // ---------- äº‹ä»¶ç¶å®š ----------
    document.getElementById("manualBtn").addEventListener("click", applyManualSchedule);
    document.getElementById("nextCourt1Btn").addEventListener("click", () => nextRoundFromQueue(0));
    document.getElementById("nextCourt2Btn").addEventListener("click", () => nextRoundFromQueue(1));
    document.getElementById("saveNextBtn").addEventListener("click", saveNextManualSchedule);
    document.getElementById("resetBtn").addEventListener("click", () => {
      try { localStorage.removeItem(STORAGE_KEY); } catch (e) {}
      setupNewSession();
    });

    // ---------- å•Ÿå‹• ----------
    (function start() {
      const loaded = loadState();
      if (!loaded) {
        setupNewSession();
      } else {
        renderAll();
      }
    })();
  </script>
</body>
</html>

