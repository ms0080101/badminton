<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>羽球排場小幫手（16人 / 2場地）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 網站 ICON（你已經上傳這三個檔案） -->
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" sizes="180x180" href="icon-180.png">

  <style>
    * {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      text-align: center;
      margin: 12px 0 4px;
      font-size: 20px;
    }
    .sub-title {
      text-align: center;
      font-size: 12px;
      color: #777;
      margin-bottom: 8px;
    }

    .page {
      max-width: 1200px;
      margin: 0 auto 32px;
      padding: 0 8px 16px;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 10px;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    .btn.secondary {
      background: #444;
    }
    .btn.danger {
      background: #b71c1c;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(260px, 1.1fr) minmax(320px, 1.4fr);
      gap: 12px;
    }
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }

    .card {
      background: #fff;
      border-radius: 10px;
      padding: 10px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
    }
    .small {
      font-size: 12px;
      color: #777;
    }

    /* 玩家表格 */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th,
    td {
      border-bottom: 1px solid #eee;
      padding: 4px 4px;
      text-align: left;
    }
    th {
      background: #fafafa;
      font-weight: 600;
    }
    tbody tr:nth-child(even) {
      background: #fafafa;
    }
    input[type="text"] {
      width: 100%;
      padding: 2px 4px;
      font-size: 12px;
    }
    input[type="checkbox"] {
      transform: scale(0.9);
    }

    /* 場地圖 */
    .court-wrapper {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-top: 4px;
    }
    @media (max-width: 700px) {
      .court-wrapper {
        grid-template-columns: 1fr;
      }
    }
    .court-card {
      background: #01579b;
      color: #fff;
      border-radius: 10px;
      padding: 8px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
    }
    .court-header {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      margin-bottom: 4px;
      opacity: 0.9;
    }
    .court-label {
      font-size: 12px;
      color: #c5e1ff;
      margin-top: 4px;
      margin-bottom: 2px;
    }
    .court-board {
      background: #0b8043;
      border-radius: 8px;
      padding: 6px;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.25);
    }
    .court-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      gap: 2px;
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.4);
    }
    .court-slot {
      border: 1px solid rgba(255, 255, 255, 0.35);
      padding: 10px 2px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      background: rgba(0, 0, 0, 0.05);
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.4);
    }
    .court-slot.empty {
      opacity: 0.45;
      font-weight: 400;
    }

    .next-board {
      background: #006978;
      border-radius: 8px;
      padding: 6px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.2);
      margin-top: 4px;
    }

    /* 表示模式開關 */
    .display-toggle {
      font-size: 12px;
      margin-top: 4px;
      text-align: right;
    }
    .display-toggle label {
      margin-left: 6px;
      cursor: pointer;
    }

    /* 手動排場、預約區 */
    .form-section-title {
      font-size: 13px;
      font-weight: 600;
      margin-top: 6px;
      margin-bottom: 4px;
    }
    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
      margin-bottom: 4px;
      font-size: 12px;
    }
    .form-row label {
      min-width: 46px;
    }
    select {
      font-size: 12px;
      padding: 2px 4px;
    }

    .actions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      margin-bottom: 4px;
    }

    .next-summary {
      margin-top: 6px;
      padding: 6px;
      border-radius: 6px;
      background: #e3f2fd;
      font-size: 12px;
    }
    .next-summary strong {
      color: #0d47a1;
    }
    .round-label {
      font-size: 12px;
      color: #555;
      margin-left: 4px;
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>羽球排場小幫手（16人 / 2場地）</h1>
    <div class="sub-title">全程手動排場＋本場 / 下一場分開管理，資料自動儲存在瀏覽器</div>

    <div class="layout">
      <!-- 左：玩家列表 -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">玩家列表（1 ~ 16號）</div>
          <div class="small">可輸入暱稱；勾「啟用」代表今天會打。</div>
        </div>
        <table>
          <thead>
            <tr>
              <th style="width:40px;">號碼</th>
              <th>名字（可修改）</th>
              <th style="width:46px;">啟用</th>
              <th style="width:46px;">休息</th>
              <th style="width:60px;">上場次數</th>
            </tr>
          </thead>
          <tbody id="players-tbody"></tbody>
        </table>
      </div>

      <!-- 右：場地 + 排場 -->
      <div class="card">
        <div class="card-header">
          <div>
            <span class="card-title">本輪排場</span>
            <span class="round-label" id="round-label">第 1 輪</span>
          </div>
        </div>

        <!-- 場地圖 -->
        <div class="court-wrapper">
          <!-- 1 號場 -->
          <div class="court-card">
            <div class="court-header">
              <span>1 號場</span>
              <span id="court1-info" style="font-size:11px;opacity:.8;">本場尚未排場</span>
            </div>

            <div class="court-label">本場</div>
            <div class="court-board">
              <div class="court-grid">
                <div class="court-slot empty" id="c1-main-0">—</div>
                <div class="court-slot empty" id="c1-main-1">—</div>
                <div class="court-slot empty" id="c1-main-2">—</div>
                <div class="court-slot empty" id="c1-main-3">—</div>
              </div>
            </div>

            <div class="court-label">下一場</div>
            <div class="next-board">
              <div class="court-grid">
                <div class="court-slot empty" id="c1-next-0">—</div>
                <div class="court-slot empty" id="c1-next-1">—</div>
                <div class="court-slot empty" id="c1-next-2">—</div>
                <div class="court-slot empty" id="c1-next-3">—</div>
              </div>
            </div>
          </div>

          <!-- 2 號場 -->
          <div class="court-card">
            <div class="court-header">
              <span>2 號場</span>
              <span id="court2-info" style="font-size:11px;opacity:.8;">本場尚未排場</span>
            </div>

            <div class="court-label">本場</div>
            <div class="court-board">
              <div class="court-grid">
                <div class="court-slot empty" id="c2-main-0">—</div>
                <div class="court-slot empty" id="c2-main-1">—</div>
                <div class="court-slot empty" id="c2-main-2">—</div>
                <div class="court-slot empty" id="c2-main-3">—</div>
              </div>
            </div>

            <div class="court-label">下一場</div>
            <div class="next-board">
              <div class="court-grid">
                <div class="court-slot empty" id="c2-next-0">—</div>
                <div class="court-slot empty" id="c2-next-1">—</div>
                <div class="court-slot empty" id="c2-next-2">—</div>
                <div class="court-slot empty" id="c2-next-3">—</div>
              </div>
            </div>
          </div>
        </div>

        <!-- 顯示模式切換 -->
        <div class="display-toggle">
          顯示：
          <label><input type="radio" name="displayMode" value="number" checked> 球號</label>
          <label><input type="radio" name="displayMode" value="name"> 名字</label>
        </div>

        <!-- 手動排場（本場） -->
        <div class="form-section-title">手動排場（本場）</div>
        <div class="small">先從下拉選單選擇今天要上場的 8 個人，再按「套用本場排場」。</div>

        <div class="form-row">
          <label>1 號場</label>
          <select id="m1-0"></select>
          <select id="m1-1"></select>
          <select id="m1-2"></select>
          <select id="m1-3"></select>
        </div>
        <div class="form-row">
          <label>2 號場</label>
          <select id="m2-0"></select>
          <select id="m2-1"></select>
          <select id="m2-2"></select>
          <select id="m2-3"></select>
        </div>

        <div class="actions-row">
          <button class="btn secondary" id="apply-manual-btn">套用本場排場</button>
          <span class="small">※ 防呆：若 1、2 號場目前都有球員，會跳出提示拒絕套用。</span>
        </div>

        <!-- 下一場預約排場 -->
        <div class="form-section-title">下一場預約排場</div>
        <div class="small">預先安排下一場要上的人；再按「1號場 / 2號場 下一場上場」。</div>

        <div class="form-row">
          <label>預約 1 號場</label>
          <select id="n1-0"></select>
          <select id="n1-1"></select>
          <select id="n1-2"></select>
          <select id="n1-3"></select>
        </div>
        <div class="form-row">
          <label>預約 2 號場</label>
          <select id="n2-0"></select>
          <select id="n2-1"></select>
          <select id="n2-2"></select>
          <select id="n2-3"></select>
        </div>

        <div class="actions-row">
          <button class="btn secondary" id="save-next-btn">儲存下一場預約</button>
          <button class="btn" id="next-court1-btn">1 號場 下一場上場 ▶</button>
          <button class="btn" id="next-court2-btn">2 號場 下一場上場 ▶</button>
        </div>

        <div class="actions-row">
          <button class="btn danger" id="reset-btn">重置排場與上場次數</button>
        </div>

        <!-- 下一場預約名單總覽 -->
        <div class="next-summary" id="next-summary">
          下一場預約（名單總覽）會顯示在這裡。
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEY = "badmintonScheduler_v2";

    let state = {
      round: 1,
      displayMode: "number", // number | name
      players: [],
      courts: {
        current: {
          1: [null, null, null, null],
          2: [null, null, null, null],
        },
        next: {
          1: [null, null, null, null],
          2: [null, null, null, null],
        },
      },
    };

    function initDefaultPlayers() {
      state.players = Array.from({ length: 16 }, (_, i) => ({
        id: i + 1,
        name: (i + 1) + "號",
        enabled: true,
        rest: false,
        plays: 0,
      }));
    }

    function loadState() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        try {
          const data = JSON.parse(raw);
          state = Object.assign(state, data);
          // 確保結構存在
          if (!state.players || state.players.length !== 16) {
            initDefaultPlayers();
          }
        } catch (e) {
          console.error("loadState error", e);
          initDefaultPlayers();
        }
      } else {
        initDefaultPlayers();
      }
    }

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function getPlayerById(id) {
      if (!id) return null;
      return state.players.find((p) => p.id === id) || null;
    }

    function formatPlayerLabel(id) {
      const p = getPlayerById(id);
      if (!p) return "—";
      if (state.displayMode === "name" && p.name.trim() !== "") {
        return p.name.trim();
      }
      return p.id + "號";
    }

    function renderPlayers() {
      const tbody = document.getElementById("players-tbody");
      tbody.innerHTML = state.players
        .map(
          (p, idx) => `
        <tr>
          <td>${p.id}</td>
          <td>
            <input type="text" value="${p.name.replace(/"/g, "&quot;")}"
              oninput="handleNameChange(${idx}, this.value)" />
          </td>
          <td style="text-align:center;">
            <input type="checkbox" ${p.enabled ? "checked" : ""} onchange="handleEnabledChange(${idx}, this.checked)" />
          </td>
          <td style="text-align:center;">
            <input type="checkbox" ${p.rest ? "checked" : ""} onchange="handleRestChange(${idx}, this.checked)" />
          </td>
          <td>${p.plays}</td>
        </tr>
      `
        )
        .join("");
    }

    function renderCourtBoards() {
      const courts = state.courts.current;
      const next = state.courts.next;

      // 1 號場
      courts[1].forEach((pid, i) => {
        const el = document.getElementById(`c1-main-${i}`);
        const filled = !!pid;
        el.textContent = filled ? formatPlayerLabel(pid) : "—";
        el.classList.toggle("empty", !filled);
      });
      next[1].forEach((pid, i) => {
        const el = document.getElementById(`c1-next-${i}`);
        const filled = !!pid;
        el.textContent = filled ? formatPlayerLabel(pid) : "—";
        el.classList.toggle("empty", !filled);
      });

      // 2 號場
      courts[2].forEach((pid, i) => {
        const el = document.getElementById(`c2-main-${i}`);
        const filled = !!pid;
        el.textContent = filled ? formatPlayerLabel(pid) : "—";
        el.classList.toggle("empty", !filled);
      });
      next[2].forEach((pid, i) => {
        const el = document.getElementById(`c2-next-${i}`);
        const filled = !!pid;
        el.textContent = filled ? formatPlayerLabel(pid) : "—";
        el.classList.toggle("empty", !filled);
      });

      // 場地狀態文字
      const c1Has = courts[1].some((id) => !!id);
      const c2Has = courts[2].some((id) => !!id);
      document.getElementById("court1-info").textContent = c1Has
        ? "本場進行中"
        : "本場尚未排場";
      document.getElementById("court2-info").textContent = c2Has
        ? "本場進行中"
        : "本場尚未排場";

      // 輪次
      document.getElementById("round-label").textContent =
        "第 " + state.round + " 輪";
    }

    function buildPlayerOptions() {
      const opts = ['<option value="">空</option>'].concat(
        state.players
          .filter((p) => p.enabled)
          .map(
            (p) => `<option value="${p.id}">${p.id}號 - ${p.name}</option>`
          )
      );
      const optionHtml = opts.join("");

      const ids = [
        "m1-0",
        "m1-1",
        "m1-2",
        "m1-3",
        "m2-0",
        "m2-1",
        "m2-2",
        "m2-3",
        "n1-0",
        "n1-1",
        "n1-2",
        "n1-3",
        "n2-0",
        "n2-1",
        "n2-2",
        "n2-3",
      ];
      ids.forEach((id) => {
        const sel = document.getElementById(id);
        const prev = sel.value || "";
        sel.innerHTML = optionHtml;
        sel.value = prev;
      });
    }

    function renderNextSummary() {
      const n1 = state.courts.next[1];
      const n2 = state.courts.next[2];

      const listToText = (arr) => {
        const ids = arr.filter((id) => !!id);
        if (!ids.length) return "（尚未預約）";
        return ids.map((id) => formatPlayerLabel(id)).join("、");
      };

      const html = `
        <div><strong>1 號場：</strong> ${listToText(n1)}</div>
        <div><strong>2 號場：</strong> ${listToText(n2)}</div>
      `;
      document.getElementById("next-summary").innerHTML = html;
    }

    function renderAll() {
      renderPlayers();
      buildPlayerOptions();
      renderCourtBoards();
      renderNextSummary();
    }

    // === 事件處理 ===
    window.handleNameChange = function (idx, val) {
      state.players[idx].name = val;
      saveState();
      renderCourtBoards();
      renderNextSummary();
    };
    window.handleEnabledChange = function (idx, checked) {
      state.players[idx].enabled = checked;
      saveState();
      buildPlayerOptions();
    };
    window.handleRestChange = function (idx, checked) {
      state.players[idx].rest = checked;
      saveState();
    };

    function readSelectValue(id) {
      const v = document.getElementById(id).value;
      const n = parseInt(v, 10);
      return isNaN(n) ? null : n;
    }

    function addPlaysFor(ids) {
      ids.forEach((id) => {
        const p = getPlayerById(id);
        if (p) p.plays++;
      });
    }

    // 防呆：若 1、2 號場本場都已有人，拒絕套用本場排場
    function applyManualToCurrent() {
      const current = state.courts.current;
      const court1Has = current[1].some((id) => !!id);
      const court2Has = current[2].some((id) => !!id);

      if (court1Has && court2Has) {
        alert(
          "目前 1 號場與 2 號場的本場都還有球員在打球，無法套用本場排場。\n\n請先讓其中一個場地結束（或清空本場排場），再重新套用。"
        );
        return;
      }

      const m1 = [
        readSelectValue("m1-0"),
        readSelectValue("m1-1"),
        readSelectValue("m1-2"),
        readSelectValue("m1-3"),
      ];
      const m2 = [
        readSelectValue("m2-0"),
        readSelectValue("m2-1"),
        readSelectValue("m2-2"),
        readSelectValue("m2-3"),
      ];

      // 只有「目前本場沒有在打」的場地，才允許套用
      if (!court1Has) {
        state.courts.current[1] = m1;
        addPlaysFor(m1.filter((id) => !!id));
      }
      if (!court2Has) {
        state.courts.current[2] = m2;
        addPlaysFor(m2.filter((id) => !!id));
      }

      state.round++;
      saveState();
      renderAll();
    }

    function saveNextReservation() {
      state.courts.next[1] = [
        readSelectValue("n1-0"),
        readSelectValue("n1-1"),
        readSelectValue("n1-2"),
        readSelectValue("n1-3"),
      ];
      state.courts.next[2] = [
        readSelectValue("n2-0"),
        readSelectValue("n2-1"),
        readSelectValue("n2-2"),
        readSelectValue("n2-3"),
      ];

      saveState();
      renderAll();
    }

    function bringNextToCourt(courtNo) {
      const nextArr = state.courts.next[courtNo];
      const filledCount = nextArr.filter((id) => !!id).length;
      if (filledCount < 4) {
        alert("預約名單尚未排滿 4 人，無法上場。");
        return;
      }
      // 直接讓預約名單上場
      state.courts.current[courtNo] = [...nextArr];
      addPlaysFor(nextArr);
      state.courts.next[courtNo] = [null, null, null, null];
      state.round++;
      saveState();
      renderAll();
    }

    function resetAll() {
      if (
        !confirm(
          "確定要重置嗎？\n\n這會清除：\n- 本場與下一場的排場\n- 所有人的上場次數\n\n名字與啟用狀態會保留。"
        )
      ) {
        return;
      }
      state.courts.current[1] = [null, null, null, null];
      state.courts.current[2] = [null, null, null, null];
      state.courts.next[1] = [null, null, null, null];
      state.courts.next[2] = [null, null, null, null];
      state.players.forEach((p) => (p.plays = 0));
      state.round = 1;
      saveState();
      renderAll();
    }

    function initDisplayModeToggle() {
      const radios = document.querySelectorAll('input[name="displayMode"]');
      radios.forEach((r) => {
        r.checked = r.value === state.displayMode;
        r.addEventListener("change", (e) => {
          if (e.target.checked) {
            state.displayMode = e.target.value;
            saveState();
            renderCourtBoards();
            renderNextSummary();
          }
        });
      });
    }

    // === 初始化 ===
    loadState();

    document
      .getElementById("apply-manual-btn")
      .addEventListener("click", applyManualToCurrent);
    document
      .getElementById("save-next-btn")
      .addEventListener("click", saveNextReservation);
    document
      .getElementById("next-court1-btn")
      .addEventListener("click", () => bringNextToCourt(1));
    document
      .getElementById("next-court2-btn")
      .addEventListener("click", () => bringNextToCourt(2));
    document
      .getElementById("reset-btn")
      .addEventListener("click", resetAll);

    initDisplayModeToggle();
    renderAll();
  </script>
</body>
</html>
